name: Terraform Apply

# Trigger on push to main (which happens after PR merge)
on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**/*.tf'
      - '.github/workflows/terraform-apply.yml'

env:
  TERRAFORM_VERSION: 1.5.0

jobs:
  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Find Terraform Directories
        id: find_dirs
        run: |
          # Find all directories with .tf files
          DIRS=$(find terraform -name "*.tf" -type f | xargs -I {} dirname {} | sort -u)
          echo "Found terraform directories:"
          echo "$DIRS"
          # Take the first (most recent) directory
          WORKING_DIR=$(echo "$DIRS" | head -1)
          echo "Using directory: $WORKING_DIR"
          echo "working_dir=$WORKING_DIR" >> $GITHUB_OUTPUT

      - name: Terraform Format Check
        if: steps.find_dirs.outputs.working_dir
        run: terraform fmt -check
        working-directory: ${{ steps.find_dirs.outputs.working_dir }}
        continue-on-error: true

      - name: Terraform Init
        if: steps.find_dirs.outputs.working_dir
        run: terraform init
        working-directory: ${{ steps.find_dirs.outputs.working_dir }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Validate
        if: steps.find_dirs.outputs.working_dir
        run: terraform validate
        working-directory: ${{ steps.find_dirs.outputs.working_dir }}

      - name: Terraform Plan
        if: steps.find_dirs.outputs.working_dir
        run: |
          terraform plan -out=tfplan \
            -var="subscription_id=$ARM_SUBSCRIPTION_ID" \
            -var="client_id=$ARM_CLIENT_ID" \
            -var="client_secret=$ARM_CLIENT_SECRET" \
            -var="tenant_id=$ARM_TENANT_ID"
        working-directory: ${{ steps.find_dirs.outputs.working_dir }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Apply
        if: steps.find_dirs.outputs.working_dir
        run: terraform apply -auto-approve tfplan
        working-directory: ${{ steps.find_dirs.outputs.working_dir }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Post Apply Summary
        if: always() && steps.find_dirs.outputs.working_dir
        run: |
          echo "## Terraform Apply Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Merge to main detected" >> $GITHUB_STEP_SUMMARY
          echo "✅ Terraform plan validated" >> $GITHUB_STEP_SUMMARY
          echo "✅ Infrastructure deployed to Azure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resources Created/Updated:**" >> $GITHUB_STEP_SUMMARY
          terraform output -json 2>/dev/null | jq -r 'to_entries[] | "- \(.key): \(.value.value)"' >> $GITHUB_STEP_SUMMARY || echo "- Check Azure Portal for details" >> $GITHUB_STEP_SUMMARY
        working-directory: ${{ steps.find_dirs.outputs.working_dir }}

      - name: Notify on Failure
        if: failure()
        run: |
          echo "❌ Terraform apply failed!"
          echo "Please check the workflow logs and fix the Terraform configuration."
          exit 1
